import Head from "next/head";
import { Inter } from "@next/font/google";
import { Category, Discount, Penalty, Sport } from "@prisma/client";
import { prisma } from "lib/prisma";
import SingleSelection from "@/components/ui/SingleSelection";
import Card from "@/components/Card";
import { useEffect, useState } from "react";
import { Player, PlayerSport, onePlayer, twoPlayers } from "@/utils/calc";

const inter = Inter({ subsets: ["latin"] });

export async function getStaticProps() {
	try {
		const categories = await prisma.category.findMany();
		const discounts = await prisma.discount.findMany();
		const penalties = await prisma.penalty.findMany();
		const sports = await prisma.sport.findMany({
			include: {
				DiscountOptions: true,
				Category: true,
				Penalty: true,
			},
		});
		return {
			props: {
				categories,
				discounts,
				penalties,
				sports: sports.map((x) => ({
					...x,
					createdAt: x.createdAt.toString(),
					updatedAt: x.updatedAt.toString(),
				})),
			},
		};
	} catch (error) {
		return {
			props: {},
		};
	}
}

export default function Home({
	categories = [],
	discounts = [],
	penalties = [],
	sports = [],
}: {
	categories: Category[] | null;
	discounts: Discount[] | null;
	penalties: Penalty[] | null;
	sports: PlayerSport[] | null;
}) {
	const [selectedCategoryId, setSelectedCategoryId] = useState<number>(1);
	const [sportsList, setSportsList] = useState<PlayerSport[]>([]);
	const [selectedSportId, setSelectedSportId] = useState<number>();
	const [selectedSportsList, setSelectedSportsList] = useState<PlayerSport[]>([]);
	const [playersResultList, setPlayersResultList] = useState<Player[]>([]);
	const [playerName, setPlayerName] = useState("");
	const [playersList, setPlayersList] = useState<Player[]>([]);

	const onSelectedCategoryChange = (categoryId: number) => {
		setSelectedCategoryId(categoryId);
		const sportsList = sports?.filter((sport) => sport.categoryId === categoryId);
		setSportsList((prev) => {
			if (sportsList) {
				setSelectedSportId(sportsList[0].id);
				return sportsList;
			}
			return [];
		});
	};

	const onSelectedSportChange = (sportId: number) => {
		setSelectedSportId(sportId);
	};

	const onSportAdded = (sportId: Number | undefined) => {
		if (!sportId) return;
		const exist = selectedSportsList.some((sport) => sport.id === sportId);
		if (exist) return;
		const selectedSport = sportsList.find((sport) => sport.id === sportId);

		setSelectedSportsList((prev) => {
			if (selectedSport) {
				return [...prev, selectedSport].sort((s1, s2) =>
					s1.price < s2.price ? 1 : s1.price > s2.price ? -1 : 0
				);
			}
			return prev;
		});
	};

	const calculationHandler = () => {
		const result = twoPlayers(playersList);
		const refracted = result?.map((player) => {
			return {
				name: player.name,
				sports: player.sports.map((sport) => ({
					name: sport.name,
					price: sport.price,
				})),
			};
		}) as Player[];
		setPlayersResultList(refracted);
	};

	useEffect(() => {
		if (categories && sports) {
			const sportsList = sports?.filter((sport) => sport.categoryId === selectedCategoryId);
			if (!sportsList) return;
			setSportsList(sportsList ?? []);
			setSelectedSportId(sportsList[0]?.id);
		}
		// eslint-disable-next-line react-hooks/exhaustive-deps
	}, []);

	return (
		<>
			<Head>
				<title>Create Next App</title>
				<meta name="description" content="Generated by create next app" />
				<meta name="viewport" content="width=device-width, initial-scale=1" />
				<link rel="icon" href="/favicon.ico" />
			</Head>
			<h1 className="text-3xl font-bold underline">Hello world!</h1>
			{/* {JSON.stringify(categories, null, 2)} */}
			{/* {categories?.map((cat) => (
				<h1 key={cat.id}>{cat.name}</h1>
			))} */}
			{/* <div className="flex">
				{categories ? categories.map((cat) => <Card key={cat.id} title={cat.name} />) : ""}
			</div> */}
			{categories ? (
				<SingleSelection
					optionsList={categories.map((cat) => (
						<option key={cat.id} value={cat.id}>
							{cat.name}
						</option>
					))}
					value={selectedCategoryId}
					onChange={(e) => onSelectedCategoryChange(Number(e.target.value))}
				/>
			) : (
				""
			)}
			{discounts ? (
				<SingleSelection
					optionsList={discounts.map((dis) => (
						<option key={dis.id} value={dis.id}>
							{dis.name}
						</option>
					))}
				/>
			) : (
				""
			)}
			{penalties ? (
				<SingleSelection
					optionsList={penalties.map((pen) => (
						<option key={pen.id} value={pen.id}>
							{pen.name}
						</option>
					))}
				/>
			) : (
				""
			)}
			{sportsList ? (
				<SingleSelection
					optionsList={sportsList.map((sport) => (
						<option key={sport.id} value={sport.id}>
							{sport.name}
						</option>
					))}
					value={selectedSportId}
					onChange={(e) => onSelectedSportChange(Number(e.target.value))}
				/>
			) : (
				""
			)}
			<div className="flex flex-col gap-4">
				<button
					onClick={() => {
						setPlayersList((prev) => [...prev, { name: playerName, sports: selectedSportsList }]);
						setPlayerName("");
						setSelectedSportsList([]);
					}}
				>
					New
				</button>
				<input
					className="bg-gray-500"
					onChange={(e) => setPlayerName(e.target.value)}
					value={playerName}
				/>
				<button onClick={() => onSportAdded(selectedSportId)}>Add</button>
				{JSON.stringify(selectedSportsList, null, 2)}
				<button onClick={() => calculationHandler()}>cal</button>
				{JSON.stringify(playersResultList, null, 2)}
			</div>
		</>
	);
}
